name: 每日更新广告过滤规则

on:
  schedule:
    - cron: "0 15 * * *"  # 每天 UTC 时间 14:00（北京时间 22:00）

jobs:
  update-filter:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 创建规则目录
        run: mkdir -p rules

      - name: 下载规则
        run: |
          echo "开始下载规则文件..."
          if ! curl -fsSL "https://easylist-downloads.adblockplus.org/easylistchina.txt" -o rules/easylistchina.txt; then
            echo "::error::下载失败！"
            exit 1
          fi
          echo "下载完成，文件大小: $(du -h rules/easylistchina.txt | cut -f1)"

      - name: 处理规则
        run: |
          echo "处理规则文件中..."
          # 移除元素隐藏规则
          grep -Ev "#[#@$?]|!#" rules/easylistchina.txt > rules/EasylistChina_NoEle.txt
          # 添加文件头说明
          echo "! 最后更新时间: $(date +'%Y-%m-%d %H:%M:%S')" | cat - rules/EasylistChina_NoEle.txt > rules/temp && \
          mv rules/temp rules/EasylistChina_NoEle.txt
          
          echo "规则统计信息:"
          wc -l rules/EasylistChina_NoEle.txt
          echo "处理完成"

      - name: 推送更新
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          echo "检查文件变更..."
          git add rules/
          
          if git diff-index --quiet HEAD --; then
            echo "没有变化需要提交"
          else
            echo "检测到变更，准备提交..."
            git commit -m "自动更新: 广告过滤规则 [$(date +'%Y-%m-%d')]"
            git push
            echo "更新已推送"
          fi
