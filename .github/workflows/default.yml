name: 广告过滤规则每日更新

on:
  schedule:
    - cron: "0 15 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-filter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: 下载并合并规则
        run: |
          set -euo pipefail
          mkdir -p rules
          
          # 定义规则源数组
          sources=(
            "EasylistChina_NoEle|https://easylist-downloads.adblockplus.org/easylistchina.txt"
            "CJX-annoyance|https://fastly.jsdelivr.net/gh/cjx82630/cjxlist/CJX-annoyance.txt"
            "EasyPrivacy|https://filters.adtidy.org/extension/chromium/filters/118_optimized.txt"
            "Xinggsf|https://fastly.jsdelivr.net/gh/xinggsf/Adblock-Plus-Rule/rule.txt"
          )
          
          # 并行下载和处理规则
          for item in "${sources[@]}"; do
            IFS='|' read -r name url <<< "$item"
            (curl -fsSL "$url" | grep -Ev "!|##|#@#|#\?#" > "rules/$name.txt" || true) &
          done
          wait
          
          # 生成合并文件
          {
            echo "[Adblock Plus 2.0]"
            echo "! Title: MobiListChina"
            echo "! Description: mobile webpage filters"
            echo "! Version: $(date +%Y%m%d%H%M)"
            echo "! Last modified: $(date -u +"%d %b %Y %H:%M UTC")"
            echo "! Expires: $(date -u -d "+1 day" +"%d %b %Y %H:%M UTC")"
            echo "! Homepage: https://github.com/Lky777/MWCP/"
            echo "! ---------------------------------"
            cat rules/*.txt | grep -v '^!' | sort -u
          } > rules/MobiListChina.txt
          
          echo "规则数量: $(grep -v '^!' rules/MobiListChina.txt | wc -l)"

      - name: 提交更改
        if: "!contains(steps.download.outcome, 'failure')"
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add rules/MobiListChina.txt
          git diff --cached --quiet || (git commit -m "自动更新广告规则 $(date +'%Y-%m-%d')" && git push)
