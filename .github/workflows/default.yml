name: æ¯æ—¥æ›´æ–°å¹¿å‘Šè¿‡æ»¤è§„åˆ™

on:
  schedule:
    - cron: "0 15 * * *"  # æ¯å¤© UTC æ—¶é—´ 14:00ï¼ˆåŒ—äº¬æ—¶é—´ 22:00ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-filter:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œä¾¿äº git æ“ä½œ

      - name: è®¾ç½®å·¥ä½œç›®å½•
        run: |
          mkdir -p rules
          echo "è§„åˆ™ç›®å½•å·²åˆ›å»º"

      - name: ä¸‹è½½è§„åˆ™æ–‡ä»¶
        id: download
        run: |
          echo "ğŸ”„ å¼€å§‹ä¸‹è½½è§„åˆ™æ–‡ä»¶..."
          if ! curl -fsSL "https://easylist-downloads.adblockplus.org/easylistchina.txt" -o rules/easylistchina.txt; then
            echo "::error::ä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi
          filesize=$(du -h rules/easylistchina.txt | cut -f1)
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $filesize"
          echo "original_size=$filesize" >> $GITHUB_OUTPUT

      - name: å¤„ç†è§„åˆ™
        id: process
        run: |
          echo "ğŸ”§ å¼€å§‹å¤„ç†è§„åˆ™æ–‡ä»¶..."
          
          # è®¡ç®—åŸå§‹è¡Œæ•°
          original_lines=$(wc -l < rules/easylistchina.txt)
          
          # å¤„ç†è§„åˆ™
          grep -Ev "#[#@$?]|!#" rules/easylistchina.txt > rules/EasylistChina_NoEle.txt
          
          # æ·»åŠ æ–‡ä»¶å¤´
          {
            echo "! æ ‡é¢˜: EasylistChina ç®€åŒ–ç‰ˆ"
            echo "! æè¿°: ç§»é™¤äº†å…ƒç´ éšè—è§„åˆ™"
            echo "! æœ€åæ›´æ–°æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S') (UTC)"
            echo "! åŸå§‹è§„åˆ™è¡Œæ•°: $original_lines"
            cat rules/EasylistChina_NoEle.txt
          } > rules/temp && mv rules/temp rules/EasylistChina_NoEle.txt
          
          # è®¡ç®—å¤„ç†åè¡Œæ•°
          processed_lines=$(wc -l < rules/EasylistChina_NoEle.txt)
          removed_lines=$((original_lines - processed_lines))
          
          echo "ğŸ“Š è§„åˆ™ç»Ÿè®¡:"
          echo "åŸå§‹è¡Œæ•°: $original_lines"
          echo "å¤„ç†åè¡Œæ•°: $processed_lines"
          echo "ç§»é™¤è¡Œæ•°: $removed_lines"
          
          echo "::set-output name=original_lines::$original_lines"
          echo "::set-output name=processed_lines::$processed_lines"

      - name: æäº¤æ›´æ–°
        id: commit
        run: |
          # é…ç½® git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          echo "ğŸ” æ£€æŸ¥å˜æ›´..."
          git add rules/
          
          if git diff-index --quiet HEAD --; then
            echo "ğŸ”„ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œæ— éœ€æäº¤"
            echo "::set-output name=has_changes::false"
          else
            echo "ğŸ“Œ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            commit_msg="è‡ªåŠ¨æ›´æ–°: å¹¿å‘Šè¿‡æ»¤è§„åˆ™ [$(date +'%Y-%m-%d')]
            - åŸå§‹è§„åˆ™è¡Œæ•°: ${{ steps.process.outputs.original_lines }}
            - å¤„ç†åè¡Œæ•°: ${{ steps.process.outputs.processed_lines }}"
            
            git commit -m "${commit_msg}"
            git push
            echo "âœ… æ›´æ–°å·²æ¨é€"
            echo "::set-output name=has_changes::true"
          fi

      - name: è¾“å‡ºç»“æœæ‘˜è¦
        if: always()
        run: |
          echo "ğŸ“ å·¥ä½œæµæ‰§è¡Œæ‘˜è¦:"
          echo "ä¸‹è½½æ–‡ä»¶å¤§å°: ${{ steps.download.outputs.original_size }}"
          echo "åŸå§‹è§„åˆ™è¡Œæ•°: ${{ steps.process.outputs.original_lines }}"
          echo "å¤„ç†åè§„åˆ™è¡Œæ•°: ${{ steps.process.outputs.processed_lines }}"
          echo "æ˜¯å¦æœ‰å˜æ›´æäº¤: ${{ steps.commit.outputs.has_changes }}"
          echo "å·¥ä½œæµè¿è¡Œæ—¶é—´: $(date)"
